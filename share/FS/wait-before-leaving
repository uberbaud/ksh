# <@(#)tag:tw.csongor.greyshirt.net,2020-12-29,00.36.33z/2e4f741>
# vim: filetype=ksh tabstop=4 textwidth=72 noexpandtab

#: FUNCTION ^Ucommand^u ^Uarg1^u ^S[…^s ^UargN^u^]
#:   Wrapper around ^Ucommand^u and then waits for a keypress.
#:   Leave without prompting ^IIF^i
#:     1. ^Ucommand^u exited without error,
#:     2. ^VSHORTWAIT^v was set and
#:     3. ^O$^o^VSHORTWAIT^v ^T<=^t ^O$^o^VSECONDS^v, and
#:     4. ^Ucommand^u did not write to ^Istderr^i.

needs h2 h3 now readkeys warn
function wait-before-leaving {
	local rc tempF
	( now; /usr/bin/printf '  %s\n' "$@"; )>>~/log/wait-before-leaving.log
	tempF=$(mktemp)
	( # Do this is a subshell so we are sure to remove $tempF
		rcIsZero=true; notTooSoon=true; noStderrWrites=true;
		SHORTWAIT=${SHORTWAIT:-0}

		tail -f "$tempF" >&2 & pidTail=$!
		# ACTUAL COMMAND WE ARE RUNNING IN THE X11 TERMINAL WINDOW
		SPARKLE_FORCE_COLOR=true "$@" 2>$tempF
		rc=$?
		kill $pidTail

		(($rc))&&				rcIsZero=false
		((SECONDS>SHORTWAIT))||	notTooSoon=false
		[[ -s $tempF ]]&&		noStderrWrites=false

		$rcIsZero && $notTooSoon && $noStderrWrites && return

		h3 'wait-before-leaving results'
		$rcIsZero		||	warn "Exited with return code ^E$rc^e."
		$notTooSoon		||	warn "Exited too quickly. ^G(see SHORTWAIT)^g"
		$noStderrWrites	||	{ h2 "$1 2>$tempF"; print -r -- "$(<$tempF)"; }

		print '  ^WPress a key to exit.^w'|sparkle >&2
		readkeys | read
	); rm -f "$tempF"
}

# Copyright © 2020 by Tom Davis <tom@greyshirt.net>.
