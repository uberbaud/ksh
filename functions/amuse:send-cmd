# @(#)[:;oCl3#GNx=+#kQXb6I0?: 2018-01-09 19:58:56 Z tw@csongor]
# vim: filetype=ksh tabstop=4 textwidth=72 noexpandtab nowrap

#: FUNCTION ^T^Ucommand^u^t ^[^Uparameters^u^]
#:   Sends a command to the amuse player if it is running.

  # The amuse player gets the path in this order
  #  1) $AMUSE_DATA_HOME
  #  2) $XDG_DATA_HOME/amuse
  #  3) $HOME/.local/amuse
  #  4) $HOME/.amuse
  #  5) FAIL
  # We are looking for the command fifo it created, BUT it might have
  # different information than we had, so SHOULD we look for the actual
  # command file?
  #
  # At this time we won't because we can't know what AMUSE_DATA_HOME was
  # set to in some other environment, so we'll look in that same order.

function amuse:send-cmd {
	local pexp wrkpath fifo='amuse-if' atitle='^Iamuse player^i'

	pgrep -qf '^amuse: player$' ||
		die "The $atitle is not running."

	if [[ -n ${AMUSE_DATA_HOME:-} ]]; then		# 1) $AMUSE_DATA_HOME
		pexp='^S$AMUSE_DATA_HOME^s'
		wrkpath="$AMUSE_DATA_HOME"
	elif [[ -n ${XDG_DATA_HOME:-} ]]; then		# 2) $XDG_DATA_HOME/amuse
		pexp='^S$XDG_DATA_HOME^s/amuse'
		wrkpath=$XDG_DATA_HOME/amuse
	elif [[ -z ${HOME:-} ]]; then				# 5) FAIL
		die 'Neither ^SAMUSE_DATA_HOME^s, ^SXDG_DATA_HOME^s, nor ^SHOME^s is set.'
	elif [[ -d $HOME/.local ]]; then			# 3) $HOME/.local/amuse
		pexp='^S$HOME^s/.local/amuse'
		wrkpath=$HOME/.local/amuse
	else										# 4) $HOME/.amuse
		pexp='^S$HOME^s/.amuse'
		wrkpath=$HOME/.amuse
	fi

	[[ -d $wrkpath ]]||
		die "Using ^U$pexp^u, the ^Bamuse^b directory does not exist."

	cd "$wrkpath" ||
		die "Could not ^Tcd^t to ^U$pexp^u."

	[[ -p $fifo ]]||
		die "Could not find the $atitle command pipe."

	print -r -- "$*" >$fifo
}

# Copyright Â© 2018 by Tom Davis <tom@greyshirt.net>.
